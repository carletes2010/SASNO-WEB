<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>SASNO WEB PRO FINAL</title>

<link rel="manifest" href="manifest.json">
<link rel="icon" href="assets/icon.png">
<link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@300;400;700&display=swap" rel="stylesheet">
<script src="https://js.pusher.com/8.2/pusher.min.js"></script>

<style>
  /* --- layout general --- */
  body{margin:0;padding:0;font-family:'Comfortaa',sans-serif;display:flex;flex-direction:column;min-height:100vh;background:#fff}
  .hidden{display:none!important}

  /* --- vista inicio --- */
  #viewHome .logo{font-size:3.5rem;font-weight:bold;color:#e53935;text-align:center;padding:1.5rem 0 .5rem}
  #viewHome .logo img{height:70px;margin-right:10px;vertical-align:middle}
  #viewHome .container{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;padding:2rem 1rem}
  #viewHome .status-icon img{height:120px}
  #viewHome .estado{font-size:2.8rem;font-weight:bold}
  #viewHome .ubicacion{font-size:1.6rem;margin-top:1rem}

  /* --- footer --- */
  .footer{position:fixed;bottom:0;width:100%;display:flex;justify-content:center;gap:2rem;padding:1rem;border-top:1px solid #ccc;background:#fff;z-index:100}
  .footer img{height:24px;cursor:pointer}

  /* --- vista configuraci√≥n --- */
  #viewConfig{position:fixed;inset:0;background:#fff;display:none;flex-direction:column;align-items:center;justify-content:center;text-align:center;gap:2rem;z-index:10}

  /* --- overlay alerta EQW --- */
  #viewAlert{position:fixed;inset:0;background:#FFA500;display:none;flex-direction:column;justify-content:center;align-items:center;text-align:center;color:#fff;z-index:9999}
  #btnAlertClose{position:absolute;top:1.2rem;left:1.2rem;width:48px;height:48px;font-size:2rem;border:none;border-radius:50%;background:#fff;color:#000;cursor:pointer;z-index:10000}

  /* --- pop lateral --- */
  #popBox{position:fixed;top:20px;right:20px;width:200px;height:200px;border-radius:15px;background:#000;box-shadow:0 0 20px rgba(0,0,0,.5);display:none;z-index:99999}
  #popFrame{width:100%;height:100%;border:none;border-radius:15px}

  /* --- advisory fullscreen --- */
  #advBox{position:fixed;inset:0;display:none;z-index:99998}
  #advFrame{width:100%;height:100%;border:none}
  #btnAdvClose{position:fixed;top:20px;right:20px;width:50px;height:50px;font-size:2rem;border:none;border-radius:50%;background:#fff;color:#000;font-weight:bold;cursor:pointer;display:none;z-index:10000;box-shadow:0 0 10px rgba(0,0,0,.5)}
</style>
</head>
<body>

<!-- =========  VISTA INICIO ========= -->
<section id="viewHome">
  <div class="logo"><img src="assets/icon.png"> SASNO WEB</div>
  <div class="container">
    <div class="status-icon"><img src="assets/wifi.png"></div>
    <div class="estado">Monitoreando Eventos</div>
    <div class="ubicacion" id="txtLocation">üìç Detectando ubicaci√≥n‚Ä¶</div>
  </div>
</section>

<!-- =========  VISTA CONFIG ========= -->
<section id="viewConfig">
  <img src="assets/icon.png" style="height:60px">
  <h1>Configuraci√≥n</h1>

  <button id="btnSimulacro" style="padding:1rem 2rem;border:none;border-radius:30px;background:#004aad;color:#fff;font-size:1.3rem">PRUEBA DE ALERTA</button>

  <label style="font-size:1.4rem;font-weight:bold">
    Sismos menores
    <input id="chkMinor" type="checkbox" checked style="transform:scale(1.5);margin-left:.8rem">
  </label>

  <h2>SASNO 2025</h2>
</section>

<!-- =========  FOOTER ========= -->
<div class="footer">
  <img id="btnHome"   src="assets/home-icon.png">
  <img id="btnConfig" src="assets/settings-icon.png">
</div>

<!-- =========  OVERLAY ALERTA ========= -->
<section id="viewAlert">
  <button id="btnAlertClose">√ó</button>
  <img src="assets/whitelogo.png" style="height:60px;margin-bottom:1rem">
  <h1 id="alertTitle" style="font-size:3.5rem;margin:.5rem 0">¬°ALERTA S√çSMICA!</h1>
  <img src="assets/handicon.png" style="height:200px;margin:1rem 0">
  <h2 id="alertSub" style="font-size:2rem">Mant√©n la calma</h2>
</section>

<!-- =========  POP + ADVISORY ========= -->
<div id="popBox"><iframe id="popFrame"></iframe></div>
<div id="advBox"><iframe id="advFrame"></iframe></div>
<button id="btnAdvClose">√ó</button>

<!-- =========  AUDIO ========= -->
<audio id="alertAudio" src="assets/alertaudio.mp3" preload="auto"></audio>

<script>
document.addEventListener('DOMContentLoaded',()=>{

/* ---------- refsDOM ---------- */
const viewHome   =document.getElementById('viewHome');
const viewConfig =document.getElementById('viewConfig');
const viewAlert  =document.getElementById('viewAlert');
const txtLocation=document.getElementById('txtLocation');

const btnHome       =document.getElementById('btnHome');
const btnConfig     =document.getElementById('btnConfig');
const btnSimulacro  =document.getElementById('btnSimulacro');
const btnAlertClose =document.getElementById('btnAlertClose');

const popBox   =document.getElementById('popBox');
const popFrame =document.getElementById('popFrame');
const advBox   =document.getElementById('advBox');
const advFrame =document.getElementById('advFrame');
const btnAdvClose=document.getElementById('btnAdvClose');
const chkMinor =document.getElementById('chkMinor');

const alertAudio=document.getElementById('alertAudio');
const alertTitle=document.getElementById('alertTitle');
const alertSub  =document.getElementById('alertSub');

/* ---------- interacci√≥n audio ---------- */
let interacted=false;
window.addEventListener('pointerdown',()=>interacted=true,{once:true});
function playAudio(){if(interacted){alertAudio.currentTime=0;alertAudio.play();}}

/* ---------- helpers de vistas ---------- */
function show(el){el.classList.remove('hidden');}
function hide(el){el.classList.add   ('hidden');}

/* ---------- navegaci√≥n ---------- */
btnHome.onclick  =()=>{hide(viewConfig);show(viewHome );}
btnConfig.onclick=()=>{hide(viewHome );show(viewConfig);}

/* ---------- cerrar overlay / advisory ---------- */
function closeAlert (){hide(viewAlert);popBox.style.display='none';closeAdvisory();}
function closeAdvisory(){advBox.style.display='none';btnAdvClose.style.display='none';}

/* ---------- botones X ---------- */
btnAlertClose.onclick =closeAlert;
btnAdvClose .onclick =closeAdvisory;

/* ---------- simulacro manual ---------- */
btnSimulacro.onclick=()=>{
  alertTitle.textContent='¬°SIMULACRO!';
  alertSub  .textContent='Prueba de alerta';
  show(viewAlert);
  playAudio();
};

/* ---------- Pusher ---------- */
const pusher=new Pusher('0f74c31648d3adb34e1b',{cluster:'us2',forceTLS:true});
pusher.subscribe('alertas-sasno').bind('eqw',d=>{
  const {latitud,longitud,tipo}=d;

  if(tipo==='advisory'){
    if(!chkMinor.checked) return;          // usuario desactiv√≥ advisory
    closeAlert();                          // prioridad menor ‚Üí cierra alerta si estaba
    advFrame.src=`advisory.html?lat=${latitud}&lon=${longitud}`;
    advBox.style.display='block';
    btnAdvClose.style.display='block';

    popFrame.src=`pop.html?lat=${latitud}&lon=${longitud}&modo=advisory`;
    popBox.style.display='block';

    hide(viewHome);hide(viewConfig);
  }else{                                   // ALERTA EQW
    closeAdvisory();                       // prioridad m√°xima
    alertTitle.textContent='¬°ALERTA S√çSMICA!';
    alertSub  .textContent='Mant√©n la calma';
    show(viewAlert);

    if(latitud&&longitud){
      popFrame.src=`pop.html?lat=${latitud}&lon=${longitud}&modo=eqw`;
      popBox.style.display='block';
    }
    playAudio();
  }
});

/* ---------- recibir ‚ÄúcerrarAdvisory‚Äù ---------- */
window.addEventListener('message',e=>{if(e.data==='cerrarAdvisory') closeAdvisory();});

/* ---------- geolocalizaci√≥n ---------- */
if(navigator.geolocation){
  navigator.geolocation.getCurrentPosition(async p=>{
    try{
      const r=await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${p.coords.latitude}&lon=${p.coords.longitude}`);
      const d=await r.json();
      const city=d.address.city||d.address.town||d.address.village||'tu zona';
      txtLocation.textContent=`üìç Alertando para: ${city}, ${d.address.state||''}`;
    }catch{txtLocation.textContent='üìç Ubicaci√≥n no disponible';}
  },()=>txtLocation.textContent='üìç No se pudo obtener ubicaci√≥n');
}else txtLocation.textContent='üìç Geolocalizaci√≥n no compatible';
});
</script>
</body>
</html>
