<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>SASNO PRO COMPLETO</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@300;400;700&display=swap" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.13.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.13.0/mapbox-gl.css" rel="stylesheet"/>
  <script src="https://js.pusher.com/8.2/pusher.min.js"></script>

  <style>
    body { margin:0; padding:0; font-family:'Comfortaa',sans-serif; background:#fff; }
    #map { width: 100%; height: 400px; }
    .popup-card {
      position: absolute; top: 10px; right: 10px; z-index: 9999;
      background-color: rgba(30, 30, 30, 0.95); border-radius: 15px; padding: 20px;
      color: white; box-shadow: 0 0 20px rgba(0,0,0,0.6); width: 300px;
    }
    .popup-card h1 { margin: 0; font-size: 20px; color: red; }
    .anticipacion { color: red; font-size: 24px; font-weight: bold; }
    .overlay-base {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: #FFA500; z-index: 5000; display: none; justify-content: center; align-items: center; flex-direction: column;
    }
    .overlay-base.show { display: flex; }
  </style>
</head>

<body>

<div class="logo" style="text-align:center; font-size:3.5rem; color:#e53935; padding:1rem;">SASNO WEB</div>

<div id="map-container" style="position:relative; height:500px;">
  <div id="map"></div>
  <div class="popup-card">
    <p>⚠️ <b>Sismo en progreso</b></p>
    <h1>ALERTA SÍSMICA</h1>
    <p>Distancia: <b id="distancia">-- km</b></p>
    <p>ETA: <span class="anticipacion" id="eta">Calculando...</span></p>
  </div>
</div>

<div id="simulacro" class="overlay-base">
  <h1 style="font-size:4rem;">¡SIMULACRO!</h1>
</div>

<audio id="alertaudio" src="/assets/alertaudio.mp3" preload="auto"></audio>

<script>

  let map, etaS=0, startTime=null, userLocation, epicenter = [-98.91, 18.29];

  navigator.geolocation.getCurrentPosition(pos => {
    userLocation = [pos.coords.longitude, pos.coords.latitude];
    iniciarMapa();
  }, () => {
    userLocation = [-99.1332, 19.4326];
    iniciarMapa();
  });

  function iniciarMapa() {
    map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/dark-v10',
      center: [-99.1332, 19.4326],
      zoom: 5.3
    });

    map.on('load', () => {
      map.addSource('epicenter', { type:'geojson', data:{ type:'Point', coordinates:epicenter } });
      map.addLayer({ id:'epicenter-circle', type:'circle', source:'epicenter',
        paint:{ 'circle-radius':10, 'circle-color':'#ff0000' } });

      map.addSource('line', { type:'geojson', data:{ type:'Feature', geometry:{ type:'LineString', coordinates:[epicenter,userLocation] } } });
      map.addLayer({ id:'line-layer', type:'line', source:'line', paint:{ 'line-color':'#ff0000', 'line-width':2 } });
      new mapboxgl.Marker({color:"#fff"}).setLngLat(userLocation).addTo(map);

      map.addSource('ondaP', { type:'geojson', data:emptyPolygon() });
      map.addLayer({ id:'ondaP-layer', type:'line', source:'ondaP', paint:{ 'line-color':'#ff0000', 'line-width':2 } });

      map.addSource('ondaS', { type:'geojson', data:emptyPolygon() });
      map.addLayer({ id:'ondaS-layer', type:'line', source:'ondaS', paint:{ 'line-color':'#ff0000', 'line-width':2 } });

      calcularDistanciaYIniciar();
    });
  }

  function calcularDistanciaYIniciar() {
    const distancia = calcularDistancia(epicenter[1], epicenter[0], userLocation[1], userLocation[0]);
    document.getElementById("distancia").innerText = distancia.toFixed(1)+" km";
    etaS = distancia/5;
    document.getElementById("eta").innerText = etaS.toFixed(1)+" seg.";
    startTime = performance.now();
    hablarCiclo();
    requestAnimationFrame(animarOndas);
  }

  function animarOndas(ts) {
    const elapsed = (ts - startTime) / 1000;
    const radioP = 8000 * elapsed;
    const radioS = 5000 * elapsed;

    map.getSource('ondaP').setData({ type:'Feature', geometry:{ type:'Polygon', coordinates:[createCircle(epicenter, radioP)] } });
    map.getSource('ondaS').setData({ type:'Feature', geometry:{ type:'Polygon', coordinates:[createCircle(epicenter, radioS)] } });

    const restante = etaS - elapsed;
    document.getElementById("eta").innerText = (restante > 0 ? restante.toFixed(1) : 0)+" seg.";
    requestAnimationFrame(animarOndas);
  }

  function hablarCiclo() {
    const restante = Math.max(etaS - ((performance.now()-startTime)/1000), 0);
    const texto = `Alerta sísmica. Anticipación, ${Math.round(restante)} segundos.`;
    const speech = new SpeechSynthesisUtterance(texto);
    speech.lang = 'es-MX';
    speech.rate = 0.9; speech.pitch = 1;
    speech.onend = () => { if(restante>0.1){ hablarCiclo(); } };
    speechSynthesis.speak(speech);
  }

  function emptyPolygon() {
    return { type: 'Feature', geometry: { type: 'Polygon', coordinates: [[]] } };
  }

  function createCircle(center, radius, points=64) {
    const coords=[];
    const dx = radius/(111320*Math.cos(center[1]*Math.PI/180));
    const dy = radius/110574;
    for(let i=0;i<points;i++){
      const theta = (i/points)*(2*Math.PI);
      coords.push([center[0]+dx*Math.cos(theta), center[1]+dy*Math.sin(theta)]);
    }
    coords.push(coords[0]);
    return coords;
  }

  function calcularDistancia(lat1,lon1,lat2,lon2) {
    const R=6371;
    const dLat=deg2rad(lat2-lat1), dLon=deg2rad(lon2-lon1);
    const a = Math.sin(dLat/2)**2 + Math.cos(deg2rad(lat1))*Math.cos(deg2rad(lat2))*Math.sin(dLon/2)**2;
    return R*2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  }

  function deg2rad(deg){ return deg*(Math.PI/180); }

  // SIMULACRO TRIGGER DESDE PUSHER (o desde prueba manual)
  const pusher = new Pusher('0f74c31648d3adb34e1b', { cluster: 'us2', forceTLS: true });
  const channel = pusher.subscribe('alertas-sasno');
  channel.bind('simulacro', () => {
    document.getElementById("simulacro").classList.add("show");
    document.getElementById("alertaudio").play();
    setTimeout(()=>{ document.getElementById("simulacro").classList.remove("show"); }, 20000);
  });

</script>

</body>
</html>
