<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SASNO WEB</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="/assets/icon.png">
  <style>
    body { font-family:'Segoe UI',sans-serif; margin:0; padding:0; background:#fff; display:flex; flex-direction:column; min-height:100vh; }
    .logo { text-align:center; font-size:3.5rem; font-weight:bold; color:#e53935; padding:1.5rem 0 .5rem; }
    .logo img { height:70px; vertical-align:middle; margin-right:10px; }
    .container { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center; padding:2rem 1rem; }
    .status-icon img { height:120px; }
    .estado { font-size:2.8rem; font-weight:bold; }
    .ubicacion { font-size:1.6rem; margin-top:1rem; }
    .footer-icons { position:fixed; bottom:0; width:100%; display:flex; justify-content:center; gap:2rem; padding:1rem; background:#fff; border-top:1px solid #ccc; z-index:100; }
    .footer-icons img { height:24px; cursor:pointer; }
    .overlay-base { position:fixed; top:0; left:0; width:100%; height:100%; color:#fff; display:flex; flex-direction:column; justify-content:center; align-items:center; z-index:9999; text-align:center; background:#FFA500; }
    .overlay-btn { position:absolute; top:1.2rem; left:1.2rem; background:#fff; border:none; border-radius:50%; width:48px; height:48px; font-size:2rem; cursor:pointer; color:#000; }
  </style>
  <!-- Pusher -->
  <script src="https://js.pusher.com/8.2/pusher.min.js"></script>

  <!-- Script principal -->
  <script>
    // Pusher setup
    const pusher = new Pusher('0f74c31648d3adb34e1b', { cluster: 'us2', forceTLS: true });
    const channel = pusher.subscribe('alertas-sasno');
    channel.bind('eqw', data => prepararOverlay(data.titulo, data.cuerpo));

    // UI Navigation and logic
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('home-icon').onclick = () => mostrarVista('inicio');
      document.getElementById('settings-icon').onclick = () => mostrarVista('config');
      document.getElementById('alert-test-btn').onclick = mostrarSimulacro;
      mostrarVista('inicio');
    });

    // View Functions
    function mostrarVista(view) {
      document.getElementById('vista-inicio').style.display = view==='inicio'? 'flex':'none';
      document.getElementById('vista-config').style.display = view==='config'? 'flex':'none';
    }

    // Simulacro / Alerta Overlay
    function mostrarSimulacro() { prepararOverlay('¡SIMULACRO!', 'SIMULACRO DE ALERTA'); }
    function cerrarSimulacro() {
      document.getElementById('vista-simulacro').style.display='none';
      const audio = document.getElementById('alertaudio'); audio.pause(); audio.currentTime=0;
      clearTimeout(window._simTimer);
      mostrarVista('inicio');
    }
    function prepararOverlay(title, subtitle) {
      document.getElementById('sim-title').textContent=title;
      document.getElementById('sim-subtitle').textContent=subtitle;
      const overlay = document.getElementById('vista-simulacro'); overlay.style.display='flex';
      const audio = document.getElementById('alertaudio'); audio.currentTime=0; audio.play();
      clearTimeout(window._simTimer);
      window._simTimer=setTimeout(cerrarSimulacro,60000);
    }

    // Geolocation
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(async pos => {
        const {latitude,longitude}=pos.coords;
        try {
          const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`);
          const data = await res.json();
          const city = data.address.city||data.address.town||data.address.village||'tu zona';
          const state = data.address.state||'';
          document.getElementById('ubicacion-texto').textContent=`📍 Alertando para: ${city}, ${state}`;
        } catch {
          document.getElementById('ubicacion-texto').textContent='📍 Ubicación no disponible';
        }
      },()=>{document.getElementById('ubicacion-texto').textContent='📍 No se pudo obtener ubicación';});
    } else {
      document.getElementById('ubicacion-texto').textContent='📍 Geolocalización no compatible';
    }
  </script>
    const pusher = new Pusher('0f74c31648d3adb34e1b', { cluster: 'us2', forceTLS: true });
    const channel = pusher.subscribe('alertas-sasno');
    channel.bind('eqw', data => prepararOverlay(data.titulo, data.cuerpo));

    //------------------------------------------------
    // UI Navigation
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('home-icon').onclick = () => mostrarVista('inicio');
      document.getElementById('settings-icon').onclick = () => mostrarVista('config');
      document.getElementById('alert-test-btn').onclick = mostrarSimulacro;
      mostrarVista('inicio');
    });

    //------------------------------------------------
    // View Functions
    function mostrarVista(view) {
      document.getElementById('vista-inicio').style.display = view==='inicio'? 'flex':'none';
      document.getElementById('vista-config').style.display = view==='config'? 'flex':'none';
    }

    // Simulacro / Alerta Overlay
    function mostrarSimulacro() { prepararOverlay('¡SIMULACRO!', 'SIMULACRO DE ALERTA'); }
    function cerrarSimulacro() {
      document.getElementById('vista-simulacro').style.display='none';
      const audio = document.getElementById('alertaudio'); audio.pause(); audio.currentTime=0;
      clearTimeout(window._simTimer);
      mostrarVista('inicio');
    }
    function prepararOverlay(title, subtitle) {
      document.getElementById('sim-title').textContent=title;
      document.getElementById('sim-subtitle').textContent=subtitle;
      const overlay = document.getElementById('vista-simulacro'); overlay.style.display='flex';
      const audio = document.getElementById('alertaudio'); audio.currentTime=0; audio.play();
      clearTimeout(window._simTimer);
      window._simTimer=setTimeout(cerrarSimulacro,60000);
    }

    //------------------------------------------------
    // Geolocation
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(async pos => {
        const {latitude,longitude}=pos.coords;
        try {
          const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`);
          const data = await res.json();
          const city = data.address.city||data.address.town||data.address.village||'tu zona';
          const state = data.address.state||'';
          document.getElementById('ubicacion-texto').textContent=`📍 Alertando para: ${city}, ${state}`;
        } catch {
          document.getElementById('ubicacion-texto').textContent='📍 Ubicación no disponible';
        }
      },()=>{document.getElementById('ubicacion-texto').textContent='📍 No se pudo obtener ubicación';});
    } else {
      document.getElementById('ubicacion-texto').textContent='📍 Geolocalización no compatible';
    }
  </script>
</body>
</html>
