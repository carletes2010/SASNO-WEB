<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SASNO WEB</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="/assets/icon.png">
  <style>
    body { font-family:'Segoe UI',sans-serif; margin:0; padding:0; background:#fff; display:flex; flex-direction:column; min-height:100vh; }
    .logo { text-align:center; font-size:3.5rem; font-weight:bold; color:#e53935; padding:1.5rem 0 .5rem; }
    .logo img { height:70px; vertical-align:middle; margin-right:10px; }
    .container { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center; padding:2rem 1rem; }
    .status-icon img { height:120px; }
    .estado { font-size:2.8rem; font-weight:bold; }
    .ubicacion { font-size:1.6rem; margin-top:1rem; }
    .footer-icons { position:fixed; bottom:0; width:100%; display:flex; justify-content:center; gap:2rem; padding:1rem; background:#fff; border-top:1px solid #ccc; z-index:100; }
    .footer-icons img { height:24px; cursor:pointer; }
    .overlay-base { position:fixed; top:0; left:0; width:100%; height:100%; color:#fff; display:flex; flex-direction:column; justify-content:center; align-items:center; z-index:9999; text-align:center; background:#FFA500; }
    .overlay-btn { position:absolute; top:1.2rem; left:1.2rem; background:#fff; border:none; border-radius:50%; width:48px; height:48px; font-size:2rem; cursor:pointer; color:#000; }
  </style>
  <!-- Socket.IO -->
  <script src="https://cdn.socket.io/4.5.0/socket.io.min.js" integrity="sha384-+0GZjtY4xXHzkwmo7aX6ixkmKsgNHYsYAGdivgLPgAvFp8Z64KbjrKMg09WXBJ8Q" crossorigin="anonymous"></script>
  <!-- Pusher -->
  <script src="https://js.pusher.com/8.2/pusher.min.js"></script>
</head>
<body>
  <!-- VISTA INICIO -->
  <div id="vista-inicio" style="display:flex; flex-direction:column; min-height:100vh;">
    <div class="logo"><img src="/assets/icon.png" alt="SASNO Logo"> SASNO WEB</div>
    <div class="container">
      <div class="status-icon"><img src="/assets/wifi.png" alt="WiFi Icon"></div>
      <div class="estado">Monitoreando Eventos</div>
      <div class="ubicacion" id="ubicacion-texto">📍 Detectando ubicación...</div>
    </div>
  </div>

  <!-- FOOTER -->
  <div class="footer-icons">
    <img id="home-icon" src="/assets/home-icon.png" alt="Inicio">
    <img id="settings-icon" src="/assets/settings-icon.png" alt="Configuración">
  </div>

  <!-- VISTA CONFIG -->
  <div id="vista-config" style="display:none; position:fixed; top:0; left:0; width:100%; height:100vh; background:#fff; z-index:10; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center; padding:2rem;">
    <img src="/assets/icon.png" alt="SASNO Logo" style="height:60px; margin-bottom:1.5rem;">
    <h1 style="font-size:3rem; margin-bottom:2.5rem;">Configuración</h1>
    <button id="alert-test-btn" style="padding:1.2rem 2.4rem; font-size:1.5rem; border:none; border-radius:30px; background:#004aad; color:#fff; cursor:pointer; margin-bottom:2.5rem;">PRUEBA DE ALERTA</button>
    <div style="margin-bottom:3.5rem; font-size:1.8rem; font-weight:bold;">Sismos Menores <input type="checkbox" checked style="transform:scale(1.6); margin-left:1rem;"></div>
    <h2 style="font-size:2.2rem;">SASNO 2025</h2>
  </div>

  <!-- VISTA ALERTA / SIMULACRO -->
  <div id="vista-simulacro" class="overlay-base" style="display:none;">
    <button class="overlay-btn" onclick="cerrarSimulacro()">&times;</button>
    <img src="/assets/whitelogo.png" alt="SASNO Logo" style="height:60px; margin-bottom:1.5rem;">
    <h1 id="sim-title" style="font-size:4rem; margin:1.2rem 0;">¡SIMULACRO!</h1>
    <img src="/assets/handicon.png" alt="Mano" style="height:200px; margin:1.2rem 0;">
    <h2 id="sim-subtitle" style="font-size:2.5rem;">SIMULACRO DE ALERTA</h2>
  </div>

  <audio id="alertaudio" src="/assets/alertaudio.mp3" preload="auto"></audio>

  <script>
    //------------------------------------------------
    // Socket.IO events
    const socket = io();
    socket.on('alerta_sismica', data => prepararOverlay('¡ALERTA SÍSMICA!', data.message));
    socket.on('nuevo_evento', event => console.log('Evento recibido:', event));

    //------------------------------------------------
    // Pusher setup
    const pusher = new Pusher('0f74c31648d3adb34e1b', { cluster: 'us2', forceTLS: true });
    const channel = pusher.subscribe('alertas-sasno');
    channel.bind('eqw', data => prepararOverlay(data.titulo, data.cuerpo));

    //------------------------------------------------
    // UI Navigation
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('home-icon').onclick = () => mostrarVista('inicio');
      document.getElementById('settings-icon').onclick = () => mostrarVista('config');
      document.getElementById('alert-test-btn').onclick = mostrarSimulacro;
      mostrarVista('inicio');
    });

    //------------------------------------------------
    // View Functions
    function mostrarVista(view) {
      document.getElementById('vista-inicio').style.display = view==='inicio'? 'flex':'none';
      document.getElementById('vista-config').style.display = view==='config'? 'flex':'none';
    }

    // Simulacro / Alerta Overlay
    function mostrarSimulacro() { prepararOverlay('¡SIMULACRO!', 'SIMULACRO DE ALERTA'); }
    function cerrarSimulacro() {
      document.getElementById('vista-simulacro').style.display='none';
      const audio = document.getElementById('alertaudio'); audio.pause(); audio.currentTime=0;
      clearTimeout(window._simTimer);
      mostrarVista('inicio');
    }
    function prepararOverlay(title, subtitle) {
      document.getElementById('sim-title').textContent=title;
      document.getElementById('sim-subtitle').textContent=subtitle;
      const overlay = document.getElementById('vista-simulacro'); overlay.style.display='flex';
      const audio = document.getElementById('alertaudio'); audio.currentTime=0; audio.play();
      clearTimeout(window._simTimer);
      window._simTimer=setTimeout(cerrarSimulacro,60000);
    }

    //------------------------------------------------
    // Geolocation
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(async pos => {
        const {latitude,longitude}=pos.coords;
        try {
          const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`);
          const data = await res.json();
          const city = data.address.city||data.address.town||data.address.village||'tu zona';
          const state = data.address.state||'';
          document.getElementById('ubicacion-texto').textContent=`📍 Alertando para: ${city}, ${state}`;
        } catch {
          document.getElementById('ubicacion-texto').textContent='📍 Ubicación no disponible';
        }
      },()=>{document.getElementById('ubicacion-texto').textContent='📍 No se pudo obtener ubicación';});
    } else {
      document.getElementById('ubicacion-texto').textContent='📍 Geolocalización no compatible';
    }
  </script>
</body>
</html>
